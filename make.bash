#!/bin/bash

# Function to check if gcc-multilib is installed
if ! dpkg --get-selections | grep -q "^gcc-multilib[[:space:]]*install$" ; then
    echo "gcc-multilib package is not installed. Please install it now! (y/n)"
    read -r answer
    if [ "$answer" != "${answer#[Yy]}" ] ;then
        sudo apt-get update && sudo apt-get install gcc-multilib
    else
        echo "gcc-multilib is required to proceed :("
        exit 1
    fi
fi

# loop through each directory and compile all the binaries
for dir in challenge*; do
    if [ -d "$dir" ]; then
        cd "$dir"
        for file in *.c; do
            # Default flags
            flags="-fno-stack-protector -z execstack -no-pie -g -Wall -w -m32 -Wno-implicit-function-declaration -Wno-unused-result"
            
            # Modify flags for specific challenges
            if [ "$dir" == "challenge4" ]; then
                # Remove -z execstack for challenge4
                flags="-fno-stack-protector -no-pie -g -Wall -w -m32 -Wno-implicit-function-declaration -Wno-unused-result"
            elif [ "$dir" == "challenge5" ]; then
                # Remove -z execstack and -m32 for challenge5
                flags="-fno-stack-protector -no-pie -g -Wall -w -Wno-implicit-function-declaration -Wno-unused-result"
            fi
            
            # Compile the file with the specified flags
            gcc $flags "$file" -o "${file%.c}" -Wl,--no-warn-search-mismatch
        done
        cd ..
    fi
done
